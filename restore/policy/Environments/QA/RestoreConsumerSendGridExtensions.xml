<?xml version="1.0" encoding="utf-8"?>
<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" PolicySchemaVersion="0.3.0.0" TenantId="dtsrestoreqa.onmicrosoft.com" PolicyId="B2C_1A_RestoreConsumerSendGridExtensions" PublicPolicyUri="http://dtsrestoreqa.onmicrosoft.com/B2C_1A_RestoreConsumerSendGridExtensions">
    <BasePolicy>
        <TenantId>dtsrestoreqa.onmicrosoft.com</TenantId>
        <PolicyId>B2C_1A_RestoreConsumerExtensions</PolicyId>
    </BasePolicy>
    <BuildingBlocks>
        <ClaimsSchema>
            <ClaimType Id="Otp">
                <DisplayName>Secondary One-time password</DisplayName>
                <DataType>string</DataType>
            </ClaimType>
            <ClaimType Id="sendGridReqBody">
                <DisplayName>SendGrid request body</DisplayName>
                <DataType>string</DataType>
            </ClaimType>
            <ClaimType Id="VerificationCode">
                <DisplayName>Secondary Verification Code</DisplayName>
                <DataType>string</DataType>
                <UserHelpText>Enter your email verification code</UserHelpText>
                <UserInputType>TextBox</UserInputType>
            </ClaimType>
            <ClaimType Id="passwordText">
                <DisplayName>Temporarily store the password between steps</DisplayName>
                <DataType>string</DataType>
                <UserHelpText>Temporarily store the password between steps</UserHelpText>
            </ClaimType>
        </ClaimsSchema>
        <ClaimsTransformations>
            <ClaimsTransformation Id="GenerateSendGridRequestBody" TransformationMethod="GenerateJson">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="email" TransformationClaimType="personalizations.0.to.0.email" />
                    <InputClaim ClaimTypeReferenceId="otp" TransformationClaimType="personalizations.0.dynamic_template_data.otp" />
                    <InputClaim ClaimTypeReferenceId="email" TransformationClaimType="personalizations.0.dynamic_template_data.email" />
                </InputClaims>
                <InputParameters>
                    <InputParameter Id="template_id" DataType="string" Value="{Settings:sendgrid.template_id}" />
                    <InputParameter Id="from.email" DataType="string" Value="{Settings:sendgrid.from.email}" />
                    <InputParameter Id="personalizations.0.subject" DataType="string" Value="{Settings:sendgrid.personalizations.0.subject}" />
                </InputParameters>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="sendGridReqBody" TransformationClaimType="outputClaim" />
                </OutputClaims>
            </ClaimsTransformation>
            <ClaimsTransformation Id="CopyPassword" TransformationMethod="CopyClaim">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="newPassword" TransformationClaimType="inputClaim" />
                </InputClaims>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="passwordText" TransformationClaimType="outputClaim" />
                </OutputClaims>
            </ClaimsTransformation>
        </ClaimsTransformations>
        <ContentDefinitions>
            <ContentDefinition Id="api.localaccountsignup">
                <!--<LoadUri>~/tenant/default/selfAsserted.cshtml</LoadUri>
                <RecoveryUri>~/common/default_page_error.html</RecoveryUri>-->
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:2.0.0</DataUri>
            </ContentDefinition>
        </ContentDefinitions>
        <DisplayControls>
            <DisplayControl Id="emailVerificationControl" UserInterfaceControlType="VerificationControl">
                <DisplayClaims>
                    <DisplayClaim ClaimTypeReferenceId="email" Required="true" />
                    <DisplayClaim ClaimTypeReferenceId="verificationCode" ControlClaimType="VerificationCode" Required="true" />
                </DisplayClaims>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="email" />
                </OutputClaims>
                <Actions>
                    <Action Id="SendCode">
                        <ValidationClaimsExchange>
                            <ValidationClaimsExchangeTechnicalProfile TechnicalProfileReferenceId="GenerateOtp" />
                            <ValidationClaimsExchangeTechnicalProfile TechnicalProfileReferenceId="SendGrid" /> 
                        </ValidationClaimsExchange>
                    </Action>
                    <Action Id="VerifyCode">
                        <ValidationClaimsExchange>
                            <ValidationClaimsExchangeTechnicalProfile TechnicalProfileReferenceId="VerifyOtp" />
                        </ValidationClaimsExchange>
                    </Action>
                </Actions>
            </DisplayControl>
        </DisplayControls>
    </BuildingBlocks>
    <ClaimsProviders>
        <ClaimsProvider>
            <DisplayName>Copy user input password to temporary field passwordText</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="PasswordCopier">
                    <DisplayName>Copy Password Profile</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <InputClaimsTransformations>
                        <InputClaimsTransformation ReferenceId="CopyPassword" />
                    </InputClaimsTransformations>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="passwordText" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>

        <ClaimsProvider>
            <DisplayName>One time password technical profiles</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="GenerateOtp">
                    <DisplayName>Generate one time password</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.OneTimePasswordProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="Operation">GenerateCode</Item>
                        <Item Key="CodeExpirationInSeconds">1200</Item>
                        <Item Key="CodeLength">6</Item>
                        <Item Key="CharacterSet">0-9</Item>
                        <Item Key="ReuseSameCode">true</Item>
                        <Item Key="MaxNumAttempts">5</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" PartnerClaimType="identifier" />
                    </InputClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="otp" PartnerClaimType="otpGenerated" />
                    </OutputClaims>
                </TechnicalProfile>
                <TechnicalProfile Id="VerifyOtp">
                    <DisplayName>Verify one time password</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.OneTimePasswordProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="Operation">VerifyCode</Item>
                        <Item Key="UserMessage.VerificationHasExpired">You have exceed the maximum time allowed.</Item>
                        <Item Key="UserMessage.MaxRetryAttemped">You have exceed the number of retries allowed.</Item>
                        <Item Key="UserMessage.InvalidCode">You have entered the wrong code.</Item>
                        <Item Key="UserMessage.ServerError">Cannot verify the code, please try again later.</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" PartnerClaimType="identifier" />
                        <InputClaim ClaimTypeReferenceId="verificationCode" PartnerClaimType="otpToVerify" />
                    </InputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>RestfulProvider</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="SendGrid">
                    <DisplayName>Use SendGrid's email API to send the code the the user</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="ServiceUrl">https://api.sendgrid.com/v3/mail/send</Item>
                        <Item Key="AuthenticationType">Bearer</Item>
                        <Item Key="SendClaimsIn">Body</Item>
                        <Item Key="ClaimUsedForRequestPayload">sendGridReqBody</Item>
                    </Metadata>
                    <CryptographicKeys>
                        <Key Id="BearerAuthenticationToken" StorageReferenceId="B2C_1A_SendGridSecret" />
                    </CryptographicKeys>
                    <InputClaimsTransformations>
                        <InputClaimsTransformation ReferenceId="GenerateSendGridRequestBody" />
                    </InputClaimsTransformations>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="sendGridReqBody" />
                    </InputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>VerifyEmailStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="VerifyEmailStep">
                    <DisplayName>VerifyEmailStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim DisplayControlReferenceId="emailVerificationControl" />
                    </DisplayClaims>

                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="email" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectPasswordsStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectPasswordsStep">
                    <DisplayName>collectPasswordsStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="newPassword" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="newPassword" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="passwordText" />
                    </OutputClaims>
                    <ValidationTechnicalProfiles>
                        <ValidationTechnicalProfile ReferenceId="PasswordCopier" />
                    </ValidationTechnicalProfiles>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectNamesStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectNamesStep">
                    <DisplayName>collectNamesStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="givenName" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="surName" Required="true" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="givenName" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="surName" Required="true" />
                    </OutputClaims>
                    <OutputClaimsTransformations>
                        <OutputClaimsTransformation ReferenceId="CreateDisplayNameFromFirstNameAndLastName" />
                    </OutputClaimsTransformations>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectTOCStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectTOCStep">
                    <DisplayName>collectTOCStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Agree and Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="termsAndCondition_currentVersionNo" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="termsAndCondition_currentVersionNo" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectTCPStepAndCreate</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectTCPStepAndCreate">
                    <DisplayName>collectTCPStepAndCreate</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Agree and Create Account</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="testConsentAndPrivacy_currentVersionNo" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="email" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="passwordText" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="givenName" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="surName" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="displayName" />
                        <OutputClaim ClaimTypeReferenceId="termsAndCondition_currentVersionNo" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="testConsentAndPrivacy_currentVersionNo" />
                        <OutputClaim ClaimTypeReferenceId="objectId" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input" DefaultValue="true" />
                        <OutputClaim ClaimTypeReferenceId="authenticationSource" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="newUser" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="userRole" DefaultValue="Consumer" Required="true" />
                    </OutputClaims>
                    <OutputClaimsTransformations>
                        <OutputClaimsTransformation ReferenceId="SetTermsAndCondition_versionNoConsented" />
                        <OutputClaimsTransformation ReferenceId="SetTermsAndCondition_versionNoConsentedDateTime" />
                        <OutputClaimsTransformation ReferenceId="SetTestConsentAndPrivacy_versionNoConsented" />
                        <OutputClaimsTransformation ReferenceId="SetTestConsentAndPrivacy_versionNoConsentedDateTime" />
                    </OutputClaimsTransformations>
                    <ValidationTechnicalProfiles>
                        <ValidationTechnicalProfile ReferenceId="AAD-UserWriteUsingLogonEmail" />
                    </ValidationTechnicalProfiles>
                    <UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
                </TechnicalProfile>

                <!-- due to split screen on password, have to use this instead of from the base policy: notice the passwordText field-->
                <TechnicalProfile Id="AAD-UserWriteUsingLogonEmail">
                    <PersistedClaims>
                        <PersistedClaim ClaimTypeReferenceId="passwordText" PartnerClaimType="password" />                        
                    </PersistedClaims>                    
                </TechnicalProfile>

            </TechnicalProfiles>
        </ClaimsProvider>

        <!--  kept for reference
       <ClaimsProvider>
            <DisplayName>OriginalSignUpStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="LocalAccountSignUpWithLogonEmail-CustomEmail">
                    <DisplayName>OriginalSignUpStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Create</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim DisplayControlReferenceId="emailVerificationControl" />
                        <DisplayClaim ClaimTypeReferenceId="displayName" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="givenName" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="surName" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="newPassword" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="email" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="objectId" />
                        <OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input" DefaultValue="true" />
                        <OutputClaim ClaimTypeReferenceId="authenticationSource" />
                        <OutputClaim ClaimTypeReferenceId="newUser" />
                    </OutputClaims>
                    <ValidationTechnicalProfiles>
                        <ValidationTechnicalProfile ReferenceId="AAD-UserWriteUsingLogonEmail" />
                    </ValidationTechnicalProfiles>
                    <UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        -->
    </ClaimsProviders>
    <UserJourneys>
        <UserJourney Id="SignUpOrSignInCustomEmail">
            <OrchestrationSteps>

                <OrchestrationStep Order="1" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="VerifyEmailStep" TechnicalProfileReferenceId="VerifyEmailStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="2" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectPasswordsStep" TechnicalProfileReferenceId="collectPasswordsStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="3" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectNamesStep" TechnicalProfileReferenceId="collectNamesStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="4" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectTOCStep" TechnicalProfileReferenceId="collectTOCStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="5" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectTCPStepAndCreate" TechnicalProfileReferenceId="collectTCPStepAndCreate" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <!-- This step reads any user attributes that we may not have received when in the token. -->
                <OrchestrationStep Order="6" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="AADUserReadWithObjectId" TechnicalProfileReferenceId="AAD-UserReadUsingObjectId" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="7" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
            </OrchestrationSteps>
            <ClientDefinition ReferenceId="DefaultWeb" />
        </UserJourney>
    </UserJourneys>
</TrustFrameworkPolicy>