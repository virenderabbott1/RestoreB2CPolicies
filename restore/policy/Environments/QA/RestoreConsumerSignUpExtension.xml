<?xml version="1.0" encoding="utf-8"?>
<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" PolicySchemaVersion="0.3.0.0" TenantId="dtsrestoreqa.onmicrosoft.com" PolicyId="B2C_1A_RestoreConsumerSignUpExtension" PublicPolicyUri="http://dtsrestoreqa.onmicrosoft.com/B2C_1A_RestoreConsumerSignUpExtension">
    <BasePolicy>
        <TenantId>dtsrestoreqa.onmicrosoft.com</TenantId>
        <PolicyId>B2C_1A_TrustFrameworkExtensions</PolicyId>
    </BasePolicy>
    <BuildingBlocks>
        <ClaimsSchema>
            <!--firstname, lastname, password etc claims are inhertited from base policy -->
            <ClaimType Id="userRole">
                <DisplayName>Role of the user </DisplayName>
                <DataType>string</DataType>
                <AdminHelpText>Store user role </AdminHelpText>
                <UserHelpText>It will be "Consumer" </UserHelpText>
            </ClaimType>
            <ClaimType Id="dateOfBirth">
                <DisplayName>Date Of Birth</DisplayName>
                <DataType>date</DataType>
                <AdminHelpText>Store date of birth of the user </AdminHelpText>
                <UserHelpText>The date on which you were born.</UserHelpText>
                <UserInputType>DateTimeDropdown</UserInputType>
            </ClaimType>
            <ClaimType Id="Otp">
                <DisplayName>Secondary One-time password</DisplayName>
                <DataType>string</DataType>
            </ClaimType>
            <ClaimType Id="sendGridReqBody">
                <DisplayName>SendGrid request body</DisplayName>
                <DataType>string</DataType>
            </ClaimType>
            <ClaimType Id="VerificationCode">
                <DisplayName>Secondary Verification Code</DisplayName>
                <DataType>string</DataType>
                <UserHelpText>Enter your email verification code</UserHelpText>
                <UserInputType>TextBox</UserInputType>
            </ClaimType>
            <ClaimType Id="passwordText">
                <DisplayName>Temporarily store the password between steps</DisplayName>
                <DataType>string</DataType>
                <UserHelpText>Temporarily store the password between steps</UserHelpText>
            </ClaimType>

            <!-- additional cliam types to drive the logic-->
            <ClaimType Id="currentDateTime">
                <DisplayName>Current Date Time</DisplayName>
                <DataType>dateTime</DataType>
                <AdminHelpText>Current date time in UTC.</AdminHelpText>
                <UserHelpText>Current date time in UTC.</UserHelpText>
            </ClaimType>

            <!--Sample action required: Update "Value" with your Company's Policy Version. In this Sample, we have used "v16". Change this to whatever version. -->
            <ClaimType Id="AgreedToTOS">
                <DisplayName>Agreed To Terms Of Service</DisplayName>
                <DataType>string</DataType>
                <UserInputType>CheckboxMultiSelect</UserInputType>
                <Restriction>
                    <Enumeration Text="Agreed To Terms Of Service" Value="TOCv01" />
                </Restriction>
            </ClaimType>

            <!--Sample action required: Update "Value" with your Company's Policy Version. In this Sample, we have used "v16". Change this to whatever version. -->
            <ClaimType Id="AgreedToTCP">
                <DisplayName>Agreed To Test consent and privacy </DisplayName>
                <DataType>string</DataType>
                <UserInputType>CheckboxMultiSelect</UserInputType>
                <Restriction>
                    <Enumeration Text="Agreed To Test consent and privacy" Value="TCPv01" />
                </Restriction>
            </ClaimType>

            <!--Sample: This the the attribute that is stored in Azure AD B2C on the user's object-->
            <ClaimType Id="extension_AgreedToTOS">
                <DisplayName>This is the current business Terms of Service version</DisplayName>
                <DataType>string</DataType>
                <AdminHelpText>This is the current business Terms of Service version</AdminHelpText>
            </ClaimType>

            <!--Sample: This the the attribute that is stored in Azure AD B2C on the user's object-->
            <ClaimType Id="extension_AgreedToTCP">
                <DisplayName>This is the current business Terms of Service version</DisplayName>
                <DataType>string</DataType>
                <AdminHelpText>This is the current business Terms of Service version</AdminHelpText>
            </ClaimType>

            <!--Sample: This is a claim created dynamically for logic purposes only. It is used to enforce your company's current TOS version-->
            <ClaimType Id="policyTOSversion">
                <DisplayName>Terms and Conditions: Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. </DisplayName>
                <DataType>string</DataType>
                <AdminHelpText>This is the current business Terms of Service version</AdminHelpText>
                <UserInputType>Paragraph</UserInputType>
            </ClaimType>

            <!--Sample: This is a claim created dynamically for logic purposes only. It is used to enforce your company's current TOS version-->
            <ClaimType Id="policyTCPversion">
                <DisplayName>Test Consent and Privacy Notice : Your Privacy is important. Your test results will be private to you. Where required we will report results to public health officials. </DisplayName>
                <DataType>string</DataType>
                <AdminHelpText>This is the current business Terms of Service version</AdminHelpText>
                <UserInputType>Paragraph</UserInputType>
            </ClaimType>

            <!--Sample: This is a claim created dynamically for logic purposes only. It is used to trigger an OrchestrationStep that presents a
  TOS page to the end user during Sign-in flows only -->
            <ClaimType Id="renewalTOSrequired">
                <DisplayName>This variable states whether TOS requires to be renewed</DisplayName>
                <DataType>boolean</DataType>
                <AdminHelpText>This variable states whether TOS requires to be renewed</AdminHelpText>
            </ClaimType>

            <!--Sample: This is a claim created dynamically for logic purposes only. It is used to trigger an OrchestrationStep that presents a
  TOS page to the end user during Sign-in flows only -->
            <ClaimType Id="renewalTCPrequired">
                <DisplayName>This variable states whether TOS requires to be renewed</DisplayName>
                <DataType>boolean</DataType>
                <AdminHelpText>This variable states whether TOS requires to be renewed</AdminHelpText>
            </ClaimType>
        </ClaimsSchema>

        <ClaimsTransformations>

            <ClaimsTransformation Id="GenerateSendGridRequestBody" TransformationMethod="GenerateJson">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="email" TransformationClaimType="personalizations.0.to.0.email" />
                    <InputClaim ClaimTypeReferenceId="otp" TransformationClaimType="personalizations.0.dynamic_template_data.otp" />
                    <InputClaim ClaimTypeReferenceId="email" TransformationClaimType="personalizations.0.dynamic_template_data.email" />
                </InputClaims>
                <InputParameters>
                    <InputParameter Id="template_id" DataType="string" Value="{Settings:sendgrid.template_id}" />
                    <InputParameter Id="from.email" DataType="string" Value="{Settings:sendgrid.from.email}" />
                    <InputParameter Id="personalizations.0.subject" DataType="string" Value="{Settings:sendgrid.personalizations.0.subject}" />
                </InputParameters>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="sendGridReqBody" TransformationClaimType="outputClaim" />
                </OutputClaims>
            </ClaimsTransformation>
            <ClaimsTransformation Id="CopyPassword" TransformationMethod="CopyClaim">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="newPassword" TransformationClaimType="inputClaim" />
                </InputClaims>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="passwordText" TransformationClaimType="outputClaim" />
                </OutputClaims>
            </ClaimsTransformation>

            <!-- combine firstname and lastname. Useful to know in the B2C UI otherwise it shows as unknown -->
            <ClaimsTransformation Id="CreateDisplayNameFromFirstNameAndLastName" TransformationMethod="FormatStringMultipleClaims">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="givenName" TransformationClaimType="inputClaim1" />
                    <InputClaim ClaimTypeReferenceId="surName" TransformationClaimType="inputClaim2" />
                </InputClaims>
                <InputParameters>
                    <InputParameter Id="stringFormat" DataType="string" Value="{0} {1}" />
                </InputParameters>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="displayName" TransformationClaimType="outputClaim" />
                </OutputClaims>
            </ClaimsTransformation>
            <!-- set currentTime in the claims bag -->
            <ClaimsTransformation Id="GetCurrentDateTime" TransformationMethod="GetCurrentDateTime">
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="currentDateTime" TransformationClaimType="currentDateTime" />
                </OutputClaims>
            </ClaimsTransformation>

            <!--Sample: This returns a boolean value assigned to "renewalTOSrequired" to determine whether the user's last accepted TOS (extension_AgreedToTOS)
      equals to the current Company's TOS version (policyTOSversion). If the two variables are not equal, it will write the value "true" in the renewalTOSrequired claim.-->
            <ClaimsTransformation Id="IsTOSRequired" TransformationMethod="CompareClaims">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="policyTOSversion" TransformationClaimType="inputClaim1" />
                    <InputClaim ClaimTypeReferenceId="extension_AgreedToTOS" TransformationClaimType="inputClaim2" />
                </InputClaims>
                <InputParameters>
                    <InputParameter Id="operator" DataType="string" Value="NOT EQUAL" />
                    <InputParameter Id="ignoreCase" DataType="string" Value="true" />
                </InputParameters>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="renewalTOSrequired" TransformationClaimType="outputClaim" />
                </OutputClaims>
            </ClaimsTransformation>

            <!--Sample: This verifies whether or not the TOS button has been selected by checking if the correct variable has been 
      assigned to the AgreedToTOS button. If not selected, then "did not accept" value will be assigned to it.-->
            <ClaimsTransformation Id="AssertTOSHasBeenSelected" TransformationMethod="AssertStringClaimsAreEqual">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="AgreedToTOS" TransformationClaimType="inputClaim1" />
                    <InputClaim ClaimTypeReferenceId="policyTOSversion" TransformationClaimType="inputClaim2" />
                </InputClaims>
                <InputParameters>
                    <InputParameter Id="stringComparison" DataType="string" Value="ordinalIgnoreCase" />
                </InputParameters>
            </ClaimsTransformation>

            <!--Sample: This returns a boolean value assigned to "renewalTOSrequired" to determine whether the user's last accepted TOS (extension_AgreedToTOS)
      equals to the current Company's TOS version (policyTOSversion). If the two variables are not equal, it will write the value "true" in the renewalTOSrequired claim.-->
            <ClaimsTransformation Id="IsTCPRequired" TransformationMethod="CompareClaims">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="policyTCPversion" TransformationClaimType="inputClaim1" />
                    <InputClaim ClaimTypeReferenceId="extension_AgreedToTCP" TransformationClaimType="inputClaim2" />
                </InputClaims>
                <InputParameters>
                    <InputParameter Id="operator" DataType="string" Value="NOT EQUAL" />
                    <InputParameter Id="ignoreCase" DataType="string" Value="true" />
                </InputParameters>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="renewalTCPrequired" TransformationClaimType="outputClaim" />
                </OutputClaims>
            </ClaimsTransformation>

            <!--Sample: This verifies whether or not the TOS button has been selected by checking if the correct variable has been 
assigned to the AgreedToTOS button. If not selected, then "did not accept" value will be assigned to it.-->
            <ClaimsTransformation Id="AssertTCPHasBeenSelected" TransformationMethod="AssertStringClaimsAreEqual">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="AgreedToTCP" TransformationClaimType="inputClaim1" />
                    <InputClaim ClaimTypeReferenceId="policyTCPversion" TransformationClaimType="inputClaim2" />
                </InputClaims>
                <InputParameters>
                    <InputParameter Id="stringComparison" DataType="string" Value="ordinalIgnoreCase" />
                </InputParameters>
            </ClaimsTransformation>

        </ClaimsTransformations>


        <ContentDefinitions>
            <ContentDefinition Id="api.localaccountsignup">
                <!--<LoadUri>~/tenant/default/selfAsserted.cshtml</LoadUri>
                <RecoveryUri>~/common/default_page_error.html</RecoveryUri>-->
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:2.0.0</DataUri>
            </ContentDefinition>
        </ContentDefinitions>
        <DisplayControls>
            <DisplayControl Id="emailVerificationControl" UserInterfaceControlType="VerificationControl">
                <DisplayClaims>
                    <DisplayClaim ClaimTypeReferenceId="email" Required="true" />
                    <DisplayClaim ClaimTypeReferenceId="verificationCode" ControlClaimType="VerificationCode" Required="true" />
                </DisplayClaims>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="email" />
                </OutputClaims>
                <Actions>
                    <Action Id="SendCode">
                        <ValidationClaimsExchange>
                            <ValidationClaimsExchangeTechnicalProfile TechnicalProfileReferenceId="GenerateOtp" />
                            <ValidationClaimsExchangeTechnicalProfile TechnicalProfileReferenceId="SendGrid" />
                        </ValidationClaimsExchange>
                    </Action>
                    <Action Id="VerifyCode">
                        <ValidationClaimsExchange>
                            <ValidationClaimsExchangeTechnicalProfile TechnicalProfileReferenceId="VerifyOtp" />
                        </ValidationClaimsExchange>
                    </Action>
                </Actions>
            </DisplayControl>
        </DisplayControls>
    </BuildingBlocks>
    <ClaimsProviders>
        <ClaimsProvider>
            <DisplayName>Copy user input password to temporary field passwordText</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="PasswordCopier">
                    <DisplayName>Copy Password Profile</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <InputClaimsTransformations>
                        <InputClaimsTransformation ReferenceId="CopyPassword" />
                    </InputClaimsTransformations>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="passwordText" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>One time password technical profiles</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="GenerateOtp">
                    <DisplayName>Generate one time password</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.OneTimePasswordProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="Operation">GenerateCode</Item>
                        <Item Key="CodeExpirationInSeconds">1200</Item>
                        <Item Key="CodeLength">6</Item>
                        <Item Key="CharacterSet">0-9</Item>
                        <Item Key="ReuseSameCode">true</Item>
                        <Item Key="MaxNumAttempts">5</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" PartnerClaimType="identifier" />
                    </InputClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="otp" PartnerClaimType="otpGenerated" />
                    </OutputClaims>
                </TechnicalProfile>
                <TechnicalProfile Id="VerifyOtp">
                    <DisplayName>Verify one time password</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.OneTimePasswordProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="Operation">VerifyCode</Item>
                        <Item Key="UserMessage.VerificationHasExpired">You have exceed the maximum time allowed.</Item>
                        <Item Key="UserMessage.MaxRetryAttemped">You have exceed the number of retries allowed.</Item>
                        <Item Key="UserMessage.InvalidCode">You have entered the wrong code.</Item>
                        <Item Key="UserMessage.ServerError">Cannot verify the code, please try again later.</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" PartnerClaimType="identifier" />
                        <InputClaim ClaimTypeReferenceId="verificationCode" PartnerClaimType="otpToVerify" />
                    </InputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>RestfulProvider</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="SendGrid">
                    <DisplayName>Use SendGrid's email API to send the code the the user</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="ServiceUrl">https://api.sendgrid.com/v3/mail/send</Item>
                        <Item Key="AuthenticationType">Bearer</Item>
                        <Item Key="SendClaimsIn">Body</Item>
                        <Item Key="ClaimUsedForRequestPayload">sendGridReqBody</Item>
                    </Metadata>
                    <CryptographicKeys>
                        <Key Id="BearerAuthenticationToken" StorageReferenceId="B2C_1A_SendGridSecret" />
                    </CryptographicKeys>
                    <InputClaimsTransformations>
                        <InputClaimsTransformation ReferenceId="GenerateSendGridRequestBody" />
                    </InputClaimsTransformations>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="sendGridReqBody" />
                    </InputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>VerifyEmailStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="VerifyEmailStep">
                    <DisplayName>VerifyEmailStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" />
                    </InputClaims>
                    <!-- block this temporarily during testing - emailVerificationControl -->
                    <!-- <DisplayClaims>
                        <DisplayClaim DisplayControlReferenceId="emailVerificationControl" />
                    </DisplayClaims>
                    -->
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="email" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectPasswordsStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectPasswordsStep">
                    <DisplayName>collectPasswordsStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="newPassword" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="newPassword" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="passwordText" />
                    </OutputClaims>
                    <ValidationTechnicalProfiles>
                        <ValidationTechnicalProfile ReferenceId="PasswordCopier" />
                    </ValidationTechnicalProfiles>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectNamesStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectNamesStep">
                    <DisplayName>collectNamesStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="givenName" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="surName" Required="true" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="givenName" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="surName" Required="true" />
                    </OutputClaims>
                    <OutputClaimsTransformations>
                        <OutputClaimsTransformation ReferenceId="CreateDisplayNameFromFirstNameAndLastName" />
                    </OutputClaimsTransformations>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectTOCStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectTOCStep">
                    <DisplayName>collectTOCStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Agree and Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="policyTOSversion" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="policyTOSversion" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>LocalAccountSignUpWithLogonEmail</DisplayName>
            <TechnicalProfiles>
                <!--Sample: Provides a required Terms of Service Check-Box during sign-up-->
                <TechnicalProfile Id="LocalAccountSignUpWithLogonEmail">
                    <Metadata>
                        <Item Key="language.button_continue">Agree and Create Account</Item>
                    </Metadata>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="policyTCPversion" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="policyTCPversion" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="AgreedToTOS" DefaultValue="true" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="AgreedToTCP" DefaultValue="true" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="userRole" DefaultValue="Consumer" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>

                <!-- due to split screen on password, have to use this instead of from the base policy: notice the passwordText field-->
                <TechnicalProfile Id="AAD-UserWriteUsingLogonEmail">
                    <PersistedClaims>
                        <PersistedClaim ClaimTypeReferenceId="passwordText" PartnerClaimType="password" />
                        <PersistedClaim ClaimTypeReferenceId="AgreedToTOS" PartnerClaimType="extension_AgreedToTOS" />
                        <PersistedClaim ClaimTypeReferenceId="AgreedToTCP" PartnerClaimType="extension_AgreedToTCP" />
                    </PersistedClaims>
                </TechnicalProfile>

            </TechnicalProfiles>
        </ClaimsProvider>
    </ClaimsProviders>

    <UserJourneys>

        <UserJourney Id="ConsumerSignUp">
            <OrchestrationSteps>

                <OrchestrationStep Order="1" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="VerifyEmailStep" TechnicalProfileReferenceId="VerifyEmailStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="2" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectPasswordsStep" TechnicalProfileReferenceId="collectPasswordsStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="3" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectNamesStep" TechnicalProfileReferenceId="collectNamesStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="4" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectTOCStep" TechnicalProfileReferenceId="collectTOCStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="5" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="LocalAccountSignUpWithLogonEmail" TechnicalProfileReferenceId="LocalAccountSignUpWithLogonEmail" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <!-- This step reads any user attributes that we may not have received when in the token. -->
                <OrchestrationStep Order="6" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="AADUserReadWithObjectId" TechnicalProfileReferenceId="AAD-UserReadUsingObjectId" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="7" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
            </OrchestrationSteps>
            <ClientDefinition ReferenceId="DefaultWeb" />
        </UserJourney>
    </UserJourneys>
</TrustFrameworkPolicy>