<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" PolicySchemaVersion="0.3.0.0" TenantId="dtsrestorestageprd.onmicrosoft.com" PolicyId="B2C_1A_RestoreConsumerExtensions" PublicPolicyUri="http://dtsrestorestageprd.onmicrosoft.com/B2C_1A_RestoreConsumerExtensions" DeploymentMode="Development" UserJourneyRecorderEndpoint="urn:journeyrecorder:applicationinsights">
  <BasePolicy>
    <TenantId>dtsrestorestageprd.onmicrosoft.com</TenantId>
    <PolicyId>B2C_1A_TrustFrameworkExtensions</PolicyId>
  </BasePolicy>

  <!--
Policy is based on the StarterPack from where it inherits many things. 
-->

  <BuildingBlocks>
    <ClaimsSchema>

      <ClaimType Id="objectId">
        <DataType>string</DataType>
      </ClaimType>


      <!--firstname, lastname, password etc claims are inhertited from base policy -->
      <ClaimType Id="userRole">
        <DisplayName>Role of the user </DisplayName>
        <DataType>string</DataType>
        <AdminHelpText>Store user role </AdminHelpText>
        <UserHelpText>It will be "Consumer" </UserHelpText>
      </ClaimType>
      <ClaimType Id="dateOfBirth">
        <DisplayName>Date Of Birth</DisplayName>
        <DataType>date</DataType>
        <AdminHelpText>Store date of birth of the user </AdminHelpText>
        <UserHelpText>The date on which you were born.</UserHelpText>
        <UserInputType>DateTimeDropdown</UserInputType>
      </ClaimType>

      <!-- Terms and Conditions: Actual verbiage will be stored in Azure block storage in HTML. The user will store only the version number consented -->
      <ClaimType Id="termsAndCondition_currentVersionNo">
        <DisplayName>Version Number of the latest Terms and Conditions: TOCv01 </DisplayName>
        <DataType>string</DataType>
        <AdminHelpText>Read from properties file for comparison </AdminHelpText>
        <UserHelpText>Version Number of the latest Terms and Conditions. </UserHelpText>
        <UserInputType>Paragraph</UserInputType>
      </ClaimType>
      <ClaimType Id="extension_termsAndCondition_versionNoConsented">
        <DisplayName>Version Number of the Terms and Conditions consented </DisplayName>
        <DataType>string</DataType>
        <AdminHelpText>Store the version number of the Terms and Conditions user has consented </AdminHelpText>
        <UserHelpText>Version Number of the Terms and Conditions consented </UserHelpText>
      </ClaimType>
      <ClaimType Id="extension_termsAndCondition_versionNoConsentedDateTime">
        <DisplayName>Date and time Terms and Conditions consented </DisplayName>
        <DataType>dateTime</DataType>
        <AdminHelpText>Store date and time when this version of Terms and Conditions was consented </AdminHelpText>
        <UserHelpText>Date and time Terms and Conditions consented </UserHelpText>
      </ClaimType>
      <ClaimType Id="termsAndCondition_isReconsentRequired">
        <DisplayName>Is Reconsent Required</DisplayName>
        <DataType>boolean</DataType>
        <AdminHelpText>Determine after the comparison of current version with saved version </AdminHelpText>
        <UserHelpText>Is Reconsent Required </UserHelpText>
      </ClaimType>

      <!-- Test Consent and Privacy: Actual verbiage will be stored in Azure block storage in HTML. The user will store only the version number consented -->
      <ClaimType Id="testConsentAndPrivacy_currentVersionNo">
        <DisplayName>Version Number of the latest Test Consent and Privacy: TCPv01 </DisplayName>
        <DataType>string</DataType>
        <AdminHelpText>Read from properties file for comparison </AdminHelpText>
        <UserHelpText>Version Number of the latest Test Consent and Privacy. </UserHelpText>
        <UserInputType>Paragraph</UserInputType>
      </ClaimType>
      <ClaimType Id="extension_testConsentAndPrivacy_versionNoConsented">
        <DisplayName>Version Number of the Test Consent and Privacy consented </DisplayName>
        <DataType>string</DataType>
        <AdminHelpText>Store date and time when this version of Test Consent and Privacy was consented </AdminHelpText>
        <UserHelpText>Version Number of the Test Consent and Privacy consented </UserHelpText>
      </ClaimType>
      <ClaimType Id="extension_testConsentAndPrivacy_versionNoConsentedDateTime">
        <DisplayName>Date and time Test Consent and Privacy consented </DisplayName>
        <DataType>dateTime</DataType>
        <UserHelpText>Date and time Test Consent and Privacy consented </UserHelpText>
      </ClaimType>
      <ClaimType Id="testConsentAndPrivacy_isReconsentRequired">
        <DisplayName>Is Re-consent Required</DisplayName>
        <DataType>boolean</DataType>
        <AdminHelpText>Determine after the comparison of current version with saved version </AdminHelpText>
        <UserHelpText>Is Reconsent Required </UserHelpText>
      </ClaimType>

      <!-- additional cliam types to drive the logic-->
      <ClaimType Id="currentDateTime">
        <DisplayName>Current Date Time</DisplayName>
        <DataType>dateTime</DataType>
        <AdminHelpText>Current date time in UTC.</AdminHelpText>
        <UserHelpText>Current date time in UTC.</UserHelpText>
      </ClaimType>

    </ClaimsSchema>

    <ClaimsTransformations>
      <!-- combine firstname and lastname. Useful to know in the B2C UI otherwise it shows as unknown -->
      <ClaimsTransformation Id="CreateDisplayNameFromFirstNameAndLastName" TransformationMethod="FormatStringMultipleClaims">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="givenName" TransformationClaimType="inputClaim1" />
          <InputClaim ClaimTypeReferenceId="surName" TransformationClaimType="inputClaim2" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="stringFormat" DataType="string" Value="{0} {1}" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="displayName" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>
      <!-- set currentTime in the claims bag -->
      <ClaimsTransformation Id="GetCurrentDateTime" TransformationMethod="GetCurrentDateTime">
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="currentDateTime" TransformationClaimType="currentDateTime" />
        </OutputClaims>
      </ClaimsTransformation>
      <!-- set extension_termsAndCondition_versionNoConsented-->
      <ClaimsTransformation Id="SetTermsAndCondition_versionNoConsented" TransformationMethod="CreateStringClaim">
        <InputParameters>
          <InputParameter Id="value" DataType="string" Value="TOCv01" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsented" TransformationClaimType="createdClaim" />
        </OutputClaims>
      </ClaimsTransformation>
      <!-- set extension_termsAndCondition_versionNoConsentedDateTime -->
      <ClaimsTransformation Id="SetTermsAndCondition_versionNoConsentedDateTime" TransformationMethod="GetCurrentDateTime">
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsentedDateTime" TransformationClaimType="currentDateTime" />
        </OutputClaims>
      </ClaimsTransformation>

      <!-- set extension_termsAndCondition_versionNoConsented-->
      <ClaimsTransformation Id="SetTestConsentAndPrivacy_versionNoConsented" TransformationMethod="CreateStringClaim">
        <InputParameters>
          <InputParameter Id="value" DataType="string" Value="TCPv01" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsented" TransformationClaimType="createdClaim" />
        </OutputClaims>
      </ClaimsTransformation>
      <!-- set extension_termsAndCondition_versionNoConsentedDateTime -->
      <ClaimsTransformation Id="SetTestConsentAndPrivacy_versionNoConsentedDateTime" TransformationMethod="GetCurrentDateTime">
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsentedDateTime" TransformationClaimType="currentDateTime" />
        </OutputClaims>
      </ClaimsTransformation>

      <!-- Terms and Condition: check if the re-consent is required - happens when the version is changed -->
      <ClaimsTransformation Id="IsTermsAndConditionReconsentRequiredForVersion" TransformationMethod="CompareClaimToValue">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsented" TransformationClaimType="inputClaim1" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="compareTo" DataType="string" Value="TOCv01" />
          <InputParameter Id="operator" DataType="string" Value="not equal" />
          <InputParameter Id="ignoreCase" DataType="string" Value="true" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="termsAndCondition_isReconsentRequired" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <!-- Test Consent and Privacy: check if the re-consent is required - happens when the version is changed -->
      <ClaimsTransformation Id="IsTestConsentAndPrivacyReconsentRequiredForVersion" TransformationMethod="CompareClaimToValue">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsented" TransformationClaimType="inputClaim1" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="compareTo" DataType="string" Value="TCPv01" />
          <InputParameter Id="operator" DataType="string" Value="not equal" />
          <InputParameter Id="ignoreCase" DataType="string" Value="true" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="testConsentAndPrivacy_isReconsentRequired" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>
    </ClaimsTransformations>

  </BuildingBlocks>

    <!-- to show the Terms and Conditions Page-->
    <ClaimsProvider>
      <DisplayName>Terms and Conditions Page </DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="termsAndConditionsPage">
          <DisplayName>Show Terms Conditions Page </DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
            <Item Key="language.button_continue">Agree and Continue </Item>
          </Metadata>
          <DisplayClaims>
            <DisplayClaim ClaimTypeReferenceId="termsAndCondition_currentVersionNo" />
          </DisplayClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="termsAndCondition_currentVersionNo" />
          </OutputClaims>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>
    <!-- to show the Test, Consent and Privacy Page-->
    <ClaimsProvider>
      <DisplayName>Test, Consent and Privacy Page </DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="testConsentAndPrivacyPage">
          <DisplayName>Show Test Consent Privacy Page </DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
            <Item Key="language.button_continue">Agree and Continue </Item>
          </Metadata>
          <DisplayClaims>
            <DisplayClaim ClaimTypeReferenceId="testConsentAndPrivacy_currentVersionNo" />
          </DisplayClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="testConsentAndPrivacy_currentVersionNo" />
          </OutputClaims>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>

    <!-- the main signup flow -->
    <ClaimsProvider>
      <DisplayName>Signup Page </DisplayName>
      <TechnicalProfiles>

        <!-- read the last time the user consented for Terms and Conditions and see if it is required to be updated -->
        <TechnicalProfile Id="Check-TOC-Status">
          <Metadata>
            <Item Key="Operation">Read</Item>
            <Item Key="RaiseErrorIfClaimsPrincipalDoesNotExist">true</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="objectId" Required="true" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsented" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="IsTermsAndConditionReconsentRequiredForVersion" />
          </OutputClaimsTransformations>

          <IncludeTechnicalProfile ReferenceId="AAD-Common" />
        </TechnicalProfile>

        <!-- write the updated version and current time to the if the user reconsents to Terms and Condition on sign in -->
        <TechnicalProfile Id="Update-TOC-Status">
          <Metadata>
            <Item Key="Operation">Write</Item>
            <Item Key="RaiseErrorIfClaimsPrincipalDoesNotExist">true</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="objectId" Required="true" />
          </InputClaims>
          <PersistedClaims>
            <PersistedClaim ClaimTypeReferenceId="objectId" />
            <PersistedClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsented" />
          </PersistedClaims>
          <IncludeTechnicalProfile ReferenceId="AAD-Common" />
        </TechnicalProfile>

        <!-- read the last time the user consented for Test Consent and Privacy and see if it is required to be updated -->
        <TechnicalProfile Id="Check-TCP-Status">
          <Metadata>
            <Item Key="Operation">Read</Item>
            <Item Key="RaiseErrorIfClaimsPrincipalDoesNotExist">true</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="objectId" Required="true" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsented" />
            <OutputClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsentedDateTime" />
          </OutputClaims>
          <!-- <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="IsTestConsentAndPrivacyReconsentRequiredForVersion" />
          </OutputClaimsTransformations>
          -->
          <IncludeTechnicalProfile ReferenceId="AAD-Common" />
        </TechnicalProfile>

        <!-- write the updated version and current time to the if the user reconsents to Test Consent and Privacy on sign in -->
        <TechnicalProfile Id="Update-TCP-Status">
          <Metadata>
            <Item Key="Operation">Write</Item>
            <Item Key="RaiseErrorIfClaimsPrincipalDoesNotExist">true</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="objectId" Required="true" />
          </InputClaims>
          <PersistedClaims>
            <PersistedClaim ClaimTypeReferenceId="objectId" />
            <PersistedClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsented" />
            <PersistedClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsentedDateTime" />
          </PersistedClaims>
          <IncludeTechnicalProfile ReferenceId="AAD-Common" />
        </TechnicalProfile>

        <!-- Sign-up self-asserted technical profile -->
        <TechnicalProfile Id="LocalAccountSignUp">
          <DisplayName>Email signup</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
            <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
            <Item Key="language.button_continue">Agree and Sign Up</Item>
            <!-- Remove sign-up email verification -->
            <Item Key="EnforceEmailVerification">False</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
          </CryptographicKeys>

          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="objectId" />
            <OutputClaim ClaimTypeReferenceId="givenName" Required="true" />
            <OutputClaim ClaimTypeReferenceId="surName" Required="true" />

            <OutputClaim ClaimTypeReferenceId="dateOfBirth" Required="true" />
            <OutputClaim ClaimTypeReferenceId="email" PartnerClaimType="signInNames.emailAddress" Required="true" />
            <OutputClaim ClaimTypeReferenceId="newPassword" Required="true" />
            <!-- <OutputClaim ClaimTypeReferenceId="reenterPassword" Required="true" /> -->
            <OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input" DefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="authenticationSource" />
            <OutputClaim ClaimTypeReferenceId="newUser" />
            <OutputClaim ClaimTypeReferenceId="userRole" DefaultValue="Consumer" />
          </OutputClaims>

          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CreateDisplayNameFromFirstNameAndLastName" />
            <OutputClaimsTransformation ReferenceId="SetTermsAndCondition_versionNoConsented" />
            <OutputClaimsTransformation ReferenceId="SetTermsAndCondition_versionNoConsentedDateTime" />
            <OutputClaimsTransformation ReferenceId="SetTestConsentAndPrivacy_versionNoConsented" />
            <OutputClaimsTransformation ReferenceId="SetTestConsentAndPrivacy_versionNoConsentedDateTime" />
          </OutputClaimsTransformations>

          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="AAD-UserWriteUsingLogonEmail" />
          </ValidationTechnicalProfiles>

          <!-- Disable session management for sign-up page -->
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>
        <!-- During sign up, write the current time of consent, and version -->
        <TechnicalProfile Id="AAD-UserWriteUsingLogonEmail">
          <PersistedClaims>
            <PersistedClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsented" />
            <PersistedClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsentedDateTime" />
            <PersistedClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsented" />
            <PersistedClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsentedDateTime" />
          </PersistedClaims>
        </TechnicalProfile>

        <!-- main signin  -->
        <TechnicalProfile Id="SelfAsserted-LocalAccountSignin-Email">
          <DisplayName>Email Signin</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="SignUpTarget">SignUpWithLogonEmailExchange</Item>
            <Item Key="setting.operatingMode">Email</Item>
            <Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="signInName" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="signInName" Required="true" />
            <OutputClaim ClaimTypeReferenceId="password" Required="true" />
            <OutputClaim ClaimTypeReferenceId="objectId" />
            <OutputClaim ClaimTypeReferenceId="authenticationSource" />
          </OutputClaims>

          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="login-NonInteractive" />
            <ValidationTechnicalProfile ReferenceId="Check-TOC-Status" />
            <!-- <ValidationTechnicalProfile ReferenceId="Check-TCP-Status" />-->
          </ValidationTechnicalProfiles>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>

    <!-- TOC the reconsent upon signin if out of date -->
    <ClaimsProvider>
      <!-- Page that prompts for a new Terms and Condition on sign in if the users Terms and Condition is out of date-->
      <DisplayName>Terms and Condition Reconsent Page </DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="SelfAsserted-Input-TOC-SignIn">
          <DisplayName>Self Asserted ToU</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
            <Item Key="AllowGenerationOfClaimsWithNullValues">true</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
          </CryptographicKeys>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="objectId" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsented" />
            <OutputClaim ClaimTypeReferenceId="extension_termsAndCondition_versionNoConsentedDateTime" />
          </OutputClaims>
          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="Update-TOC-Status" />
          </ValidationTechnicalProfiles>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>

    <!-- TCP the reconsent upon signin if out of date -->
    <ClaimsProvider>
      <!-- Page that prompts for a new Terms and Condition on sign in if the users Terms and Condition is out of date-->
      <DisplayName>Terms and Condition Reconsent Page </DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="SelfAsserted-Input-TCP-SignIn">
          <DisplayName>Self Asserted ToU</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
            <Item Key="AllowGenerationOfClaimsWithNullValues">true</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
          </CryptographicKeys>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="objectId" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsented" />
            <OutputClaim ClaimTypeReferenceId="extension_testConsentAndPrivacy_versionNoConsentedDateTime" />
          </OutputClaims>
          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="Update-TCP-Status" />
          </ValidationTechnicalProfiles>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>


  </ClaimsProviders>

  <UserJourneys>

    <UserJourney Id="HelloWorldJourney">
      <OrchestrationSteps>
        <OrchestrationStep Order="1" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
      </OrchestrationSteps>
    </UserJourney>

    <!-- SignUp User Journey -->
    <UserJourney Id="ConsumerSignUp">
      <OrchestrationSteps>
        <!-- Show SignUp Form -->
        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="show email form" TechnicalProfileReferenceId="LocalAccountSignUpWithLogonEmail" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- all done. send token -->
        <OrchestrationStep Order="2" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
      </OrchestrationSteps>
    </UserJourney>

    <!-- SignIn User Journey -->
    <UserJourney Id="ConsumerSignIn">
      <OrchestrationSteps>
        <!-- start with signin form -->
        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="LocalAccountSignIn" TechnicalProfileReferenceId="SelfAsserted-LocalAccountSignin-Email" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- Track that we have received a sign in request -->
        <OrchestrationStep Order="2" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="TrackSignInRequest" TechnicalProfileReferenceId="AppInsights-SignInRequest" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- read the whole object by object Id -->
        <OrchestrationStep Order="3" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="AADUserReadWithObjectId" TechnicalProfileReferenceId="AAD-UserReadUsingObjectId" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <!-- Display Terms and Conditions page for any SignIn scenario based on termsAndCondition_isReconsentRequired claim -->
        <OrchestrationStep Order="4" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>termsAndCondition_isReconsentRequired</Value>
              <Value>false</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="Show TOCConsentPage followed by login" TechnicalProfileReferenceId="SelfAsserted-Input-TOC-SignIn" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <!-- Display Test Consent and Privacy page for any SignIn scenario based on testConsentAndPrivacy_isReconsentRequired claim -->
        <OrchestrationStep Order="5" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>testConsentAndPrivacy_isReconsentRequired</Value>
              <Value>false</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="ShowTCPConsentPage" TechnicalProfileReferenceId="SelfAsserted-Input-TCP-SignIn" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <!-- all done. send token -->
        <OrchestrationStep Order="6" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />

        <!-- Track that we have successfully sent a token -->
        <OrchestrationStep Order="7" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="TrackSignInComplete" TechnicalProfileReferenceId="AppInsights-SignInComplete" />
          </ClaimsExchanges>
        </OrchestrationStep>


      </OrchestrationSteps>

    </UserJourney>

  </UserJourneys>

</TrustFrameworkPolicy>