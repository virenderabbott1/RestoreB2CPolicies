<?xml version="1.0" encoding="utf-8"?>
<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" PolicySchemaVersion="0.3.0.0" TenantId="dtsrestorestage.onmicrosoft.com" PolicyId="B2C_1A_RestoreConsumerSignUpExtension" PublicPolicyUri="http://dtsrestorestage.onmicrosoft.com/B2C_1A_RestoreConsumerSignUpExtension">
    <BasePolicy>
        <TenantId>dtsrestorestage.onmicrosoft.com</TenantId>
        <PolicyId>B2C_1A_RestoreConsumerBaseExtension</PolicyId>
    </BasePolicy>    

    <ClaimsProviders>
        <ClaimsProvider>
            <DisplayName>VerifyEmailStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="VerifyEmailStep">
                    <DisplayName>VerifyEmailStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" />
                    </InputClaims>
                    <!-- block this temporarily during testing - emailVerificationControl -->
                    <!-- <DisplayClaims>
                        <DisplayClaim DisplayControlReferenceId="emailVerificationControl" />
                    </DisplayClaims>
                    -->
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="email" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectPasswordsStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectPasswordsStep">
                    <DisplayName>collectPasswordsStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="newPassword" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="newPassword" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="passwordText" />
                    </OutputClaims>
                    <ValidationTechnicalProfiles>
                        <ValidationTechnicalProfile ReferenceId="PasswordCopier" />
                    </ValidationTechnicalProfiles>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectNamesStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectNamesStep">
                    <DisplayName>collectNamesStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="givenName" Required="true" />
                        <DisplayClaim ClaimTypeReferenceId="surName" Required="true" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="givenName" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="surName" Required="true" />
                    </OutputClaims>
                    <OutputClaimsTransformations>
                        <OutputClaimsTransformation ReferenceId="CreateDisplayNameFromFirstNameAndLastName" />
                    </OutputClaimsTransformations>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>collectTOCStep</DisplayName>
            <TechnicalProfiles>
                <TechnicalProfile Id="collectTOCStep">
                    <DisplayName>collectTOCStep</DisplayName>
                    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
                    <Metadata>
                        <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
                        <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
                        <Item Key="language.button_continue">Agree and Continue</Item>
                    </Metadata>
                    <InputClaims>
                        <InputClaim ClaimTypeReferenceId="email" Required="true" />
                    </InputClaims>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="policyTOSversion" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="policyTOSversion" Required="true" />
                    </OutputClaims>
                </TechnicalProfile>
            </TechnicalProfiles>
        </ClaimsProvider>
        <ClaimsProvider>
            <DisplayName>LocalAccountSignUpWithLogonEmail</DisplayName>
            <TechnicalProfiles>
                <!--Sample: Provides a required Terms of Service Check-Box during sign-up-->
                <TechnicalProfile Id="LocalAccountSignUpWithLogonEmail">
                    <Metadata>
                        <Item Key="language.button_continue">Agree and Create Account</Item>
                    </Metadata>
                    <DisplayClaims>
                        <DisplayClaim ClaimTypeReferenceId="policyTCPversion" />
                    </DisplayClaims>
                    <OutputClaims>
                        <OutputClaim ClaimTypeReferenceId="AgreedToTOS" DefaultValue="true" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="AgreedToTCP" DefaultValue="true" Required="true" />
                        <OutputClaim ClaimTypeReferenceId="userRole" DefaultValue="Consumer" Required="true" />
                    </OutputClaims>
                    <IncludeTechnicalProfile ReferenceId="AAD-Common" />
                </TechnicalProfile>

                <!-- due to split screen on password, have to use this instead of from the base policy: notice the passwordText field-->
                <TechnicalProfile Id="AAD-UserWriteUsingLogonEmail">
                    <PersistedClaims>
                        <PersistedClaim ClaimTypeReferenceId="passwordText" PartnerClaimType="password" />
                        <PersistedClaim ClaimTypeReferenceId="userRole" PartnerClaimType="userType" />
                        <PersistedClaim ClaimTypeReferenceId="extension_AgreedToTOS" DefaultValue="TOCv01" />
                        <PersistedClaim ClaimTypeReferenceId="extension_AgreedToTCP" DefaultValue="TCPv01" />
                    </PersistedClaims>
                </TechnicalProfile>

            </TechnicalProfiles>
        </ClaimsProvider>
    </ClaimsProviders>

    <UserJourneys>
        <UserJourney Id="ConsumerSignUp">
            <OrchestrationSteps>
                <OrchestrationStep Order="1" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="VerifyEmailStep" TechnicalProfileReferenceId="VerifyEmailStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="2" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectPasswordsStep" TechnicalProfileReferenceId="collectPasswordsStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="3" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectNamesStep" TechnicalProfileReferenceId="collectNamesStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="4" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="collectTOCStep" TechnicalProfileReferenceId="collectTOCStep" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="5" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="LocalAccountSignUpWithLogonEmail" TechnicalProfileReferenceId="LocalAccountSignUpWithLogonEmail" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <!-- This step reads any user attributes that we may not have received when in hte token. -->
                <OrchestrationStep Order="6" Type="ClaimsExchange">
                    <ClaimsExchanges>
                        <ClaimsExchange Id="AADUserReadWithObjectId" TechnicalProfileReferenceId="AAD-UserReadUsingObjectId" />
                    </ClaimsExchanges>
                </OrchestrationStep>
                <OrchestrationStep Order="7" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
            </OrchestrationSteps>
            <ClientDefinition ReferenceId="DefaultWeb" />
        </UserJourney>
    </UserJourneys>
</TrustFrameworkPolicy>